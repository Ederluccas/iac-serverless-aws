# üöÄ Implementation Guide: Using API Gateway URL from Terraform Output

## üìã Overview

This guide explains how to configure your serverless application to use the **actual API Gateway URL and API Key** generated by Terraform instead of hardcoded values.

## üîß Current Problem

The frontend currently has hardcoded values in `frontend/script.js`:
```javascript
constructor() {
    this.apiUrl = 'https://68qnphjcte.execute-api.ap-southeast-2.amazonaws.com/prod';
    this.apiKey = '3NaNVleQaq3zU9aVOVyr485qceYpDw4d3fW0NB0M';
}
```

**‚ùå This means:**
- You're using someone else's API
- Your deployed infrastructure is not being used
- The hardcoded API might not work or be available

## ‚úÖ Solution: Configure with Your Terraform Outputs

### Step 1: Get Your Terraform Outputs

After running `terraform apply`, get your actual values:

```bash
# Get all outputs
terraform output

# Get specific outputs
terraform output api_gateway_url
terraform output api_key

# Get API key value (it's sensitive)
terraform output -raw api_key
```

**Example output:**
```
api_gateway_url = "https://abc123def.execute-api.us-east-1.amazonaws.com/prod"
api_key = <sensitive>
```

### Step 2: Configure the Frontend Application

#### Method A: Using the Web Interface (Recommended)

1. **Open your CloudFront URL** (from terraform output `cloudfront_domain`)
2. **Find the "Configura√ß√£o da API" section** at the top of the page
3. **Paste your values:**
   - **URL da API**: Paste the `api_gateway_url` from terraform output
   - **API Key**: Paste the `api_key` value from terraform output
4. **Click "Testar Conex√£o"** to verify it works
5. **Configuration is automatically saved** in browser localStorage

#### Method B: Update the Code Directly

Edit `frontend/script.js` and replace the hardcoded values:

```javascript
// BEFORE (hardcoded)
constructor() {
    this.apiUrl = 'https://68qnphjcte.execute-api.ap-southeast-2.amazonaws.com/prod';
    this.apiKey = '3NaNVleQaq3zU9aVOVyr485qceYpDw4d3fW0NB0M';
}

// AFTER (your Terraform outputs)
constructor() {
    this.apiUrl = 'https://YOUR_API_ID.execute-api.YOUR_REGION.amazonaws.com/prod';
    this.apiKey = 'YOUR_ACTUAL_API_KEY_FROM_TERRAFORM';
}
```

Then upload the updated file to S3:
```bash
aws s3 cp frontend/script.js s3://YOUR_BUCKET_NAME/script.js
```

### Step 3: Verify Configuration

1. **Test Connection**: Click the "Testar Conex√£o" button
2. **Expected Result**: ‚úÖ "Conex√£o estabelecida com sucesso!"
3. **Try CRUD Operations**: Add, edit, delete users
4. **Check Browser Console**: No CORS or 403 errors

## üõ†Ô∏è Automated Configuration Scripts

### PowerShell Script (Windows)

Create `configure-api.ps1`:
```powershell
# Get Terraform outputs
$API_URL = terraform output -raw api_gateway_url
$API_KEY = terraform output -raw api_key
$BUCKET = terraform output -raw s3_bucket_name

Write-Host "Configuring API with:"
Write-Host "API URL: $API_URL"
Write-Host "API Key: $($API_KEY.Substring(0,8))..."
Write-Host "S3 Bucket: $BUCKET"

# Update script.js file
$scriptContent = Get-Content "frontend/script.js" -Raw
$scriptContent = $scriptContent -replace "this\.apiUrl = '[^']*';", "this.apiUrl = '$API_URL';"
$scriptContent = $scriptContent -replace "this\.apiKey = '[^']*';", "this.apiKey = '$API_KEY';"

# Save updated file
$scriptContent | Out-File "frontend/script.js" -Encoding UTF8 -NoNewline

# Upload to S3
aws s3 cp frontend/script.js s3://$BUCKET/script.js

Write-Host "‚úÖ Configuration complete! Your app now uses your Terraform infrastructure."
```

### Bash Script (Linux/Mac)

Create `configure-api.sh`:
```bash
#!/bin/bash

# Get Terraform outputs
API_URL=$(terraform output -raw api_gateway_url)
API_KEY=$(terraform output -raw api_key)
BUCKET=$(terraform output -raw s3_bucket_name)

echo "Configuring API with:"
echo "API URL: $API_URL"
echo "API Key: ${API_KEY:0:8}..."
echo "S3 Bucket: $BUCKET"

# Update script.js file
sed -i.bak "s|this\.apiUrl = '[^']*';|this.apiUrl = '$API_URL';|g" frontend/script.js
sed -i.bak "s|this\.apiKey = '[^']*';|this.apiKey = '$API_KEY';|g" frontend/script.js

# Upload to S3
aws s3 cp frontend/script.js s3://$BUCKET/script.js

echo "‚úÖ Configuration complete! Your app now uses your Terraform infrastructure."
```

Make it executable:
```bash
chmod +x configure-api.sh
./configure-api.sh
```

## üîç Troubleshooting

### ‚ùå "403 Forbidden" Error

**Problem**: API returns 403 when testing connection

**Solution**:
1. Verify your API Key is correct:
   ```bash
   terraform output -raw api_key
   ```
2. Check if API Gateway has proper CORS configuration
3. Ensure API methods require the correct authentication

### ‚ùå "Network Error" or "Failed to Fetch"

**Problem**: Cannot reach API Gateway

**Solutions**:
1. **Check API Gateway URL format**:
   ```
   Correct: https://abc123.execute-api.us-east-1.amazonaws.com/prod
   Wrong:   https://abc123.execute-api.us-east-1.amazonaws.com (missing /prod)
   ```

2. **Verify API Gateway is deployed**:
   ```bash
   aws apigateway get-rest-apis --query 'items[?name==`iac-serverless-api`]'
   ```

3. **Check if stage exists**:
   ```bash
   aws apigateway get-stages --rest-api-id YOUR_API_ID
   ```

### ‚ùå "API Key not found" Error

**Problem**: Terraform output shows `<sensitive>` for api_key

**Solution**:
```bash
# Use -raw flag to get actual value
terraform output -raw api_key
```

### ‚ùå Configuration Doesn't Persist

**Problem**: Settings reset when page reloads

**Solution**:
1. **Browser localStorage issue**: Check if localStorage is enabled
2. **Update code**: Ensure `saveConfig()` is called after input changes
3. **Test in different browser**: Rule out browser-specific issues

## üìä Verification Checklist

- [ ] Terraform apply completed successfully
- [ ] Got API Gateway URL from `terraform output api_gateway_url`
- [ ] Got API Key from `terraform output -raw api_key`
- [ ] Configured frontend with actual values (not hardcoded)
- [ ] "Testar Conex√£o" shows success message
- [ ] Can add/edit/delete users through the interface
- [ ] No 403/CORS errors in browser console
- [ ] Configuration persists after page reload

## üéØ Quick Start Commands

```bash
# Complete setup in one go
terraform apply -auto-approve
API_URL=$(terraform output -raw api_gateway_url)
API_KEY=$(terraform output -raw api_key)
echo "Your API URL: $API_URL"
echo "Your API Key: ${API_KEY:0:8}..."
echo "Now configure these in your frontend!"
```

## üöÄ What's Next?

Once configured correctly:

1. **Bookmark your CloudFront URL** for easy access
2. **Document your API endpoints** for team usage
3. **Monitor AWS costs** in the billing dashboard
4. **Scale your application** by adding more features
5. **Set up CI/CD** to automate deployments

## üí° Pro Tips

- **Use environment variables** for local development
- **Create different stages** (dev, staging, prod) with separate Terraform workspaces  
- **Set up monitoring alerts** for API usage limits
- **Backup your Terraform state** file regularly
- **Use AWS Parameter Store** for sensitive configuration in production

---

**üéâ Congratulations! Your serverless application now uses your own AWS infrastructure!**